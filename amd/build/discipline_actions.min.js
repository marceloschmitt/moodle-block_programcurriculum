define('block_programcurriculum/discipline_actions', ['core/notification', 'core/modal_save_cancel', 'core/modal_delete_cancel', 'core/modal_events', 'core/str'], function(
    Notification,
    ModalSaveCancel,
    ModalDeleteCancel,
    ModalEvents,
    Str
) {
    'use strict';

    var attachHandlers = function() {
        var links = document.querySelectorAll('a[data-confirm-message]');
        links.forEach(function(link) {
            if (link.dataset.confirmBound === '1') {
                return;
            }
            link.dataset.confirmBound = '1';
            link.addEventListener('click', function(event) {
                event.preventDefault();
                var message = link.getAttribute('data-confirm-message') || '';
                var name = link.getAttribute('data-confirm-name') || '';
                if (name) {
                    Str.get_strings([
                        {key: 'deletedisciplinetitle', component: 'block_programcurriculum'},
                        {key: 'deletedisciplinebody', component: 'block_programcurriculum', param: name}
                    ]).then(function(strings) {
                        return ModalDeleteCancel.create({
                            title: strings[0],
                            body: strings[1]
                        }).then(function(modal) {
                            var root = modal.getRoot();
                            var navigate = function() {
                                window.location.href = link.href;
                            };
                            root.on(ModalEvents.save, navigate);
                            root.on(ModalEvents.delete, navigate);
                            modal.show();
                            return modal;
                        });
                    }).catch(Notification.exception);
                    return;
                }

                ModalDeleteCancel.create({
                    title: message,
                    body: ''
                }).then(function(modal) {
                    var root = modal.getRoot();
                    var navigate = function() {
                        window.location.href = link.href;
                    };
                    root.on(ModalEvents.save, navigate);
                    root.on(ModalEvents.delete, navigate);
                    modal.show();
                    return modal;
                }).catch(Notification.exception);
            });
        });

        var moveLinks = document.querySelectorAll('a[data-move-url]');
        moveLinks.forEach(function(link) {
            if (link.dataset.moveBound === '1') {
                return;
            }
            link.dataset.moveBound = '1';
            link.addEventListener('click', function(event) {
                event.preventDefault();

                var max = parseInt(link.getAttribute('data-max-position') || '1', 10);
                var current = parseInt(link.getAttribute('data-current-position') || '1', 10);
                var url = link.getAttribute('data-move-url') || link.href;
                var disciplineName = link.getAttribute('data-move-name') || '';

                var stringRequests = [
                    {key: 'movemodaltitle', component: 'block_programcurriculum'},
                    {key: 'movemodaltitlewithname', component: 'block_programcurriculum', param: disciplineName},
                    {key: 'move', component: 'block_programcurriculum'},
                    {key: 'cancel', component: 'moodle'},
                    {key: 'movepositioninvalid', component: 'block_programcurriculum'},
                    {key: 'movepositionhelp', component: 'block_programcurriculum', param: max},
                    {key: 'moveto', component: 'block_programcurriculum'}
                ];
                Str.get_strings(stringRequests).then(function(strings) {
                    var title = disciplineName ? strings[1] : strings[0];
                    var body = '<div class="block-programcurriculum-move">' +
                        '<div class="d-flex align-items-center gap-2 flex-wrap">' +
                        '<label class="form-label mb-0" for="block-programcurriculum-move-input">' + strings[5] + '</label>' +
                        '<input id="block-programcurriculum-move-input" type="number" min="1" max="' + max +
                        '" value="' + current + '" class="form-control form-control-sm w-auto" style="max-width: 90px;">' +
                        '<span class="text-muted">' + strings[4] + '</span>' +
                        '</div>' +
                        '</div>';
                    return ModalSaveCancel.create({
                        title: title,
                        body: body,
                        buttons: {
                            save: strings[2],
                            cancel: strings[3]
                        }
                    }).then(function(modal) {
                        modal.getRoot().on(ModalEvents.save, function(e) {
                            var input = modal.getRoot().find('#block-programcurriculum-move-input').val();
                            var position = parseInt(input, 10);
                            if (isNaN(position) || position < 1 || position > max) {
                                e.preventDefault();
                                Notification.alert('', strings[4], '');
                                return;
                            }
                            var separator = url.indexOf('?') === -1 ? '?' : '&';
                            window.location.href = url + separator + 'position=' + position;
                        });
                        modal.show();
                        return modal;
                    });
                }).catch(Notification.exception);
            });
        });

        var openModalButton = document.querySelector('[data-open-discipline-modal="1"]');
        var modalTitle = document.getElementById('programcurriculum-discipline-modal-title');
        var form = document.getElementById('programcurriculum-discipline-form');

        var setFormValue = function(name, value) {
            if (!form) {
                return;
            }
            var element = form.elements.namedItem(name);
            if (element) {
                element.value = value;
            }
        };

        var openModal = function() {
            if (openModalButton) {
                openModalButton.click();
            }
        };

        var addButton = document.querySelector('[data-action="add-discipline"]');
        if (addButton && !addButton.dataset.modalBound) {
            addButton.dataset.modalBound = '1';
            addButton.addEventListener('click', function() {
                if (modalTitle) {
                    modalTitle.textContent = modalTitle.dataset.addTitle || modalTitle.textContent;
                }
                setFormValue('id', 0);
                setFormValue('name', '');
                setFormValue('externalcode', '');
                setFormValue('sortorder', 0);
            });
        }

        var editLinks = document.querySelectorAll('a[data-action="edit-discipline"]');
        editLinks.forEach(function(link) {
            if (link.dataset.modalBound === '1') {
                return;
            }
            link.dataset.modalBound = '1';
            link.addEventListener('click', function(event) {
                event.preventDefault();
                if (modalTitle) {
                    modalTitle.textContent = modalTitle.dataset.editTitle || modalTitle.textContent;
                }
                setFormValue('id', link.dataset.editId || 0);
                setFormValue('name', link.dataset.editName || '');
                setFormValue('externalcode', link.dataset.editCode || '');
                setFormValue('sortorder', link.dataset.editSortorder || 0);
                setFormValue('curriculumid', link.dataset.editCurriculum || 0);
                openModal();
            });
        });

    };

    return {
        init: function() {
            attachHandlers();
        }
    };
});
